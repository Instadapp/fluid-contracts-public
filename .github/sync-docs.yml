# Github Action to sync fluid-docs repo whenever a new release is made

name: Sync autogenerated docs

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Clone fluid-contracts-public repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          submodules: recursive

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install deps
        shell: bash
        run: |
          #!/bin/bash
          set -e
          set -o pipefail

          forge install foundry-rs/forge-std --no-git
          forge install a16z/erc4626-tests --no-git
          forge install transmissions11/solmate@b5c9aed --no-git
          forge install OpenZeppelin/openzeppelin-contracts@v4.8.2 --no-git
          forge install OpenZeppelin/openzeppelin-contracts-upgradeable@v4.8.2 --no-git
          npm ci

      - name: Generate docs
        shell: bash
        run: |
          #!/bin/bash
          set -e
          set -o pipefail

          forge doc --build

      - name: Cache Foundry dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.foundry
            lib/
          key: ${{ runner.os }}-foundry-${{ hashFiles('foundry.toml') }}

      - name: Clone fluid-docs repo
        uses: actions/checkout@v4
        with:
          repository: instadapp/fluid-docs
          token: ${{ secrets.FLUID_DOCS_GITHUB_TOKEN }}
          path: fluid-docs

      - name: Install deps
        shell: bash
        run: |
          #!/bin/bash
          set -e
          set -o pipefail

          npm ci

      - name: Remove old docs and copy new docs
        shell: bash
        run: |
          #!/bin/bash
          set -e
          set -o pipefail

          rm -rf fluid-docs/autogenerated-docs
          cp -r docs/contracts/src/contracts/* fluid-docs/autogenerated-docs

      - name: Run auto-generate-route script
        shell: bash
        run: |
          #!/bin/bash
          set -e
          set -o pipefail

          npm run docs:auto-generate-route

      - name: Commit and push docs
        env:
          GIT_TERMINAL_PROMPT: "0"
        run: |
          #!/bin/bash

          set -e
          set -o pipefail

          git config --global user.name 'InstadappHQ'
          git config --global user.email 'info@instadapp.io'
          echo "Set github user"

          git add .
          git commit -m "chore: [gh-action] sync docs"
          echo "Committed changes"

          mkdir -p ~/.ssh
          echo -n ${{ secrets.PUBLIC_DEPLOY_KEY }} | base64 -d > ~/.ssh/id_rsa
          chmod 400 ~/.ssh/id_rsa

          git push origin main
          echo "Pushed changes to fluid-docs repo"


